{% extends 'base.html' %}
{% load static %}

{% block content %}
<!--<h2>Ventas</h2>
<div class="row mb-3">
    <div class="col">
        <input type="date" class="form-control" id="fecha-filtro">
    </div>
    <div class="col">
        <select class="form-control" id="vendedor-filtro">
            <option value="">Todos los vendedores</option>
            {% for usuario in usuarios %}
            <option value="{{ usuario.id }}">{{ usuario.username }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col">
        <button class="btn btn-primary" id="filtrar">FILTRAR</button>
    </div>
</div>-->
<p class="page_tittle">
    Gestión de Ventas
</p>
<div class="form_filter" id="my_form_filter">
    <button class="addButton" id="openDiaVentaAdd">
        <i class="fas fa-plus-circle"></i>
        <span>Agregar Venta</span>
    </button>

    
    <button class="excelButton" id="excelButton">
        <i class="fas fa-file-excel"></i>
        <span>Crear excel</span>
    </button>
</div>
<table class="table" id="myTable">
    <thead>
        <tr>
            <th># Venta</th>
            <th>Descripción</th>
            <th>Vendedor</th>
            <th>Fecha de Creación</th>
            <th>Acción</th>
        </tr>
    </thead>
    <tbody id="ventas-table-body">
        {% for Venta in Ventas %}
        <tr>
            <td>{{ venta.id }}</td>

            <td><button class="btn btn-link btn-sm ver-detalle" data-venta-id="{{ venta.id }}">...</button></td>

            <td>{{ venta.vendedor.username }}</td>

            <td>{{ venta.fecha_creacion|date:"Y-m-d" }}</td>

            <td>
                <button class="btn btn-danger btn-sm eliminar-venta" data-venta-id="{{ venta.id }}">
                    <i class="fas fa-trash"></i>
                </button>
            </td>

        </tr>
        {% endfor %}
    </tbody>
</table>


<script>
    document.getElementById('exportarForm').addEventListener('submit', function (event) {
      var productoIds = [];
      var rows = document.querySelectorAll('tbody tr');
      rows.forEach(function (row) {
        productoIds.push(row.getAttribute('data-producto-id'));
      });
      document.getElementById('productoIds').value = productoIds.join(',');
    });
  </script>
<!-- Dialogs-->
<!-- Crear Ventas -->
<dialog id="DiaVentaAdd">
    <div class="top_bar_myDialog">
      <span class="tittle">Agregar venta</span>
      <i class="fas fa-times close_myDialog" id="closeDiaVentaAdd"></i>
    </div>
    
    <div class="content_myDialog">
        <div class="form-row">
            <div class="form-group">
              <label for="producto_select">Producto:</label>
              <select id="producto_select" required>
                <option value="">Selecciona un producto</option>
                {% for producto in productos %}
                <option value="{{ producto.id }}" data-precio="{{ producto.precio_venta }}">{{ producto.nombre }}</option>
                {% endfor %}
              </select>
            </div>
            
            <div class="form-group">
              <label for="unidades_input">Unidades:</label>
              <input type="number" id="unidades_input" min="1" value="1" required>
            </div>
            
            <button type="button" id="agregarProducto">AGREGAR PRODUCTO</button>
          </div>
          
      <form method="post" action="{% url 'crear_venta' %}" id="ventaForm">
        {% csrf_token %}
  
        <table id="productosTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Producto</th>
              <th>Precio Unitario</th>
              <th>Unidades</th>
              <th>Importe</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
            <!-- Los productos se agregarán aquí dinámicamente -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" style="text-align: right;"><strong>Total:</strong></td>
              <td id="totalVenta">S/. 0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
        
        <input type="hidden" id="total-venta" name="total">
        
        <div class="buttons_container">
          <button type="button" id="cancelDiaVentaAdd" class="btn-secondary">CANCELAR</button>
          <button type="submit" class="btn-primary">CREAR</button>
        </div>
      </form>
    </div>
  </dialog>

<!-- Formulario Detalle de Venta -->
<dialog id="detalleVentaForm" style="width: 800px; height: 70vh;">
    <div class="top_bar_myDialog" style="width: 100%;">
      <span class="tittle">Detalle de Venta</span>
      <i class="fas fa-times close_myDialog" id="closeDetalleVentaForm"></i>
    </div>
    
    <div class="content_myDialog" style="width: 100%; height: calc(70vh - 40px); overflow-y: auto;">
      <!-- Formulario Detalle de Venta -->
      <form method="post" action="{% url 'crear_excel' %}">
        {% csrf_token %}
        
        <p>Número de Venta: <span id="ventaId"></span></p>
        <p>Fecha de Creación: <span id="fechaCreacion"></span></p>
        <p>Vendedor: <span id="nombreVendedor"></span></p>
        
        <table class="table">
          <thead>
            <tr>
              <th># Producto</th>
              <th>Nombre Producto</th>
              <th>Precio Unitario</th>
              <th>Unidades</th>
              <th>Importe</th>
            </tr>
          </thead>
          <tbody id="detalleProductosBody">
            <!-- Contenido de productos se carga dinámicamente aquí -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="text-right"><strong>Total</strong></td>
              <td><span id="importeTotal"></span></td>
            </tr>
          </tfoot>
        </table>
        
        <div class="buttons_container_add_form buttons_container" id="cancelDetalleVentaForm">
          <button type="button" class="btn btn-secondary" id="cerrar-form">Cerrar</button>
          <button type="submit" class="btn btn-success">Descargar Excel</button>
        </div>
      </form>
    </div>
  </dialog>
  

{% endblock %}

{% block scripts %}

<script src="{% static 'js/Ventas/dialogVentas.js' %}"></script>
{% endblock %}
